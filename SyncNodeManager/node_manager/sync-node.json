{
   "AWSTemplateFormatVersion":"2010-09-09",
   "Description":"Sync Node Stack",
   "Parameters":{
      "Environment":{
         "Description":"Environment",
         "AllowedValues":[
            "dev",
            "stage",
            "prod"
         ],
         "Default":"stage",
         "Type":"String"
      },
      "SyncNodeInstanceType":{
         "Description":"Sync Node Instance Type",
         "Default":"m1.xlarge",
         "AllowedValues":[
            "m1.large",
            "m1.xlarge",
            "m3.medium",
            "m3.large",
            "m3.xlarge",
            "m3.2xlarge",
            "c1.medium",
            "c1.xlarge",
            "c3.large",
            "c3.xlarge",
            "c3.2xlarge",
            "c3.4xlarge",
            "c3.8xlarge",
            "cc2.8xlarge",
            "m2.xlarge",
            "m2.2xlarge",
            "m2.4xlarge",
            "cr1.8xlarge",
            "hi1.4xlarge",
            "hs1.8xlarge",
            "i2.xlarge",
            "i2.2xlarge",
            "i2.4xlarge",
            "i2.8xlarge",
            "t1.micro",
            "cg1.4xlarge",
            "g2.2xlarge"
         ],
         "ConstraintDescription":"must be a valid EC2 instance type.",
         "Type":"String"
      },
      "ProvisioningVersion":{
         "Description":"Puppet code version. The RPM version of puppet-config-common and puppet-config-sync_1_5 used to provision the stack. This value can be either a version number (e.g. 20131220135603) or 'latest' to get the newest code. Versions can be found here : https://github.com/mozilla-services/puppet-config/tags",
         "Default":"latest",
         "AllowedPattern":"[0-9]{14}|latest",
         "ConstraintDescription":"must either be the string 'latest' or an all numeric rpm version like 20131220135603",
         "Type":"String"
      },
      "NodeSecrets":{
         "Description":"Node secrets used to make or verify auth-token signatures. These secrets should be derived from the token servers master secret and be 64 character hexadecimal strings",
         "Type":"CommaDelimitedList"
      },
      "NodeNumber":{
         "Description":"Node number which will start the DNS name for the node",
         "AllowedPattern":"[0-9]*",
         "ConstraintDescription":"must be a string consisting of digits",
         "Type":"String"
      },
      "AMI":{
         "Description":"AMI ID to use to create the instance",
         "AllowedPattern":"ami-[0-9a-f]{8}",
         "ConstraintDescription":"must be a valid AMI ID in the form of ami-56789abc",
         "Type":"String"
      },
      "AvailabilityZone":{
         "Description":"Availability Zone to launch the instance in",
         "AllowedPattern":"[a-z]{2}-[a-z]*-[0-9][a-z]",
         "ConstraintDescription":"must be a valid availability zone in the form of us-west-2a",
         "Type":"String"
      }
   },
   "Mappings":{
      "AccountMap":{
         "142069644989":{
            "SyncNodeKeyPair":"20130730-svcops-base-key-dev",
            "Name":"moz-svc-dev-old",
            "AccountType":"EC2-Classic"
         },
         "351644144250":{
            "SyncNodeKeyPair":"20130730-svcops-base-key-prod",
            "Name":"moz-svc-prod-old",
            "AccountType":"EC2-Classic"
         },
         "361527076523":{
            "SyncNodeKeyPair":"20130730-svcops-base-key-prod",
            "Name":"moz-svc-prod",
            "AccountType":"EC2-VPC"
         },
         "613808223628":{
            "SyncNodeKeyPair":"20130730-svcops-base-key-prod",
            "Name":"moz-svc-dev",
            "AccountType":"EC2-VPC"
         },
         "123456789012":{
            "SyncNodeKeyPair":"This value is never used but is required for validation. Otherwise you'll get the error 'Template error: Unable to get mapping for AccountMap::123456789012::SyncNodeKeyPair'",
            "Name":"This value is never used but is required",
            "AccountType":"This value is never used but is required"
         }
      },
      "EnvironmentMap":{
         "dev":{
            "DNSZone":"dev.mozaws.net."
         },
         "stage":{
            "DNSZone":"stage.mozaws.net."
         },
         "prod":{
            "DNSZone":"sync.services.mozilla.com."
         }
      },
      "VariableMap":{
         "Stack":{
            "App":"sync_1_5",
            "Type":"all_in_one_node"
         }
      }
   },
   "Conditions":{
      "IsEC2-VPC":{
         "Fn::Equals":[
            {
               "Fn::FindInMap":[
                  "AccountMap",
                  {
                     "Ref":"AWS::AccountId"
                  },
                  "AccountType"
               ]
            },
            "EC2-VPC"
         ]
      }
   },
   "Resources":{
      "SyncNodeRole":{
         "Type":"AWS::IAM::Role",
         "Properties":{
            "AssumeRolePolicyDocument":{
               "Statement":[
                  {
                     "Effect":"Allow",
                     "Principal":{
                        "Service":[
                           "ec2.amazonaws.com"
                        ]
                     },
                     "Action":[
                        "sts:AssumeRole"
                     ]
                  }
               ]
            },
            "Path": {"Fn::Join":["",["/",{"Fn::FindInMap":[ "VariableMap", "Stack", "App" ]},"/"]]},
            "Policies":[
               {
                  "PolicyName":"PuppetConfigDeployIAMRequirements",
                  "PolicyDocument":{
                     "Version":"2012-10-17",
                     "Statement":[
                        {
                           "Effect":"Allow",
                           "Action":[
                              "S3:ListBucket",
                              "S3:GetObject"
                           ],
                           "Resource":[
                              "arn:aws:s3:::net.mozaws.ops.hiera-secrets",
                              "arn:aws:s3:::net.mozaws.prod.ops.rpmrepo-protected",
                              "arn:aws:s3:::net.mozaws.ops.rpmrepo-puppet"
                           ]
                        },
                        {
                           "Effect":"Allow",
                           "Action":[
                              "S3:GetObject"
                           ],
                           "Resource":[
                               "arn:aws:s3:::net.mozaws.ops.rpmrepo-protected/*",
                               "arn:aws:s3:::net.mozaws.ops.rpmrepo-puppet/*",
                               "arn:aws:s3:::net.mozaws.ops.hiera-secrets/common.yaml",
                               {"Fn::Join":["",["arn:aws:s3:::net.mozaws.ops.hiera-secrets/type/",{"Fn::FindInMap":[ "VariableMap", "Stack", "App" ]},".",{"Fn::FindInMap":[ "VariableMap", "Stack", "Type" ]},".",{"Ref":"Environment"},".",{"Ref":"AWS::StackName"},".","yaml"]]},
                               {"Fn::Join":["",["arn:aws:s3:::net.mozaws.ops.hiera-secrets/type/",{"Fn::FindInMap":[ "VariableMap", "Stack", "App" ]},".",{"Fn::FindInMap":[ "VariableMap", "Stack", "Type" ]},".",{"Ref":"Environment"},".","yaml"]]},
                               {"Fn::Join":["",["arn:aws:s3:::net.mozaws.ops.hiera-secrets/type/",{"Fn::FindInMap":[ "VariableMap", "Stack", "App" ]},".",{"Fn::FindInMap":[ "VariableMap", "Stack", "Type" ]},".","yaml"]]},
                               {"Fn::Join":["",["arn:aws:s3:::net.mozaws.ops.hiera-secrets/app/",{"Fn::FindInMap":[ "VariableMap", "Stack", "App" ]},".",{"Ref":"Environment"},".",{"Ref":"AWS::StackName"},".","yaml"]]},
                               {"Fn::Join":["",["arn:aws:s3:::net.mozaws.ops.hiera-secrets/app/",{"Fn::FindInMap":[ "VariableMap", "Stack", "App" ]},".",{"Ref":"Environment"},".","yaml"]]},
                               {"Fn::Join":["",["arn:aws:s3:::net.mozaws.ops.hiera-secrets/app/",{"Fn::FindInMap":[ "VariableMap", "Stack", "App" ]},".","yaml"]]},
                               {"Fn::Join":["",["arn:aws:s3:::net.mozaws.ops.hiera-secrets/env/",{"Ref":"Environment"},".",{"Ref":"AWS::StackName"},".","yaml"]]},
                               {"Fn::Join":["",["arn:aws:s3:::net.mozaws.ops.hiera-secrets/env/",{"Ref":"Environment"},".","yaml"]]}
                           ]
                        },
                        {
                           "Effect":"Allow",
                           "Action":[
                              "ec2:DescribeTags",
                              "ec2:DescribeRegions"
                           ],
                           "Resource":"*"
                        }
                     ]
                  }
               }
            ]
         }
      },
      "SyncNodeInstanceProfile":{
         "Type":"AWS::IAM::InstanceProfile",
         "Properties":{
            "Path": {"Fn::Join":["",["/",{"Fn::FindInMap":[ "VariableMap", "Stack", "App" ]},"/"]]},
            "Roles":[
               {
                  "Ref":"SyncNodeRole"
               }
            ]
         }
      },
      "SyncNodeSecurityGroup":{
         "Type":"AWS::EC2::SecurityGroup",
         "Properties":{
            "GroupDescription":"Firefox Accounts Sync Node Security Group",
            "SecurityGroupIngress":[
               {
                  "FromPort":"443",
                  "IpProtocol":"tcp",
                  "CidrIp":"0.0.0.0/0",
                  "ToPort":"443"
               }
            ],
            "Tags":[
               {
                  "Key":"App",
                  "Value":{"Fn::FindInMap":[ "VariableMap", "Stack", "App" ]}
               },
               {
                  "Key":"Env",
                  "Value":{
                     "Ref":"Environment"
                  }
               },
               {
                  "Key":"Type",
                  "Value":{"Fn::FindInMap":[ "VariableMap", "Stack", "Type" ]}
               },
               {
                  "Key":"Stack",
                  "Value":{
                     "Ref":"AWS::StackName"
                  }
               },
               {
                  "Key":"Name",
                  "Value":"sync-node"
               },
               {
                  "Key":"Services",
                  "Value":"sync1.5"
               }
            ]
         }
      },
      "SyncNodeInstance":{
         "Type":"AWS::EC2::Instance",
         "Metadata":{
            "AWS::CloudFormation::Init":{
               "config":{
                  "commands":{
                     "50_manage_puppet_update_configs_and_secrets":{
                        "command":{
                           "Fn::Join":[
                              " ",
                              [
                                 "/etc/puppet/bin/manage_puppet",
                                 "--update-configs puppet-config-common",
                                 {
                                    "Ref":"ProvisioningVersion"
                                 },
                                 "--update-configs puppet-config-sync_1_5",
                                 {
                                    "Ref":"ProvisioningVersion"
                                 },
                                 "--update-secrets",
                                 "--apply",
                                 "--apply-options \"--logdest /var/log/initial_puppet_apply.log\"",
                                 "2>&1 > /var/log/initial_manage_puppet.log"
                              ]
                           ]
                        },
                        "cwd":"~"
                     }
                  }
               }
            },
            "Puppet":{
               "environment":{
                  "Ref":"Environment"
               },
               "region":{
                  "Ref":"AWS::Region"
               },
               "stackname":{
                  "Ref":"AWS::StackName"
               },
               "nodesecrets":{
                  "Ref":"NodeSecrets"
               }
            }
         },
         "Properties":{
            "AvailabilityZone":{
                "Ref":"AvailabilityZone"
            },
            "IamInstanceProfile":{
               "Ref":"SyncNodeInstanceProfile"
            },
            "ImageId":{
                "Ref":"AMI"
            },
            "InstanceType":{
               "Ref":"SyncNodeInstanceType"
            },
            "KeyName":{
               "Fn::FindInMap":[
                  "AccountMap",
                  {
                     "Ref":"AWS::AccountId"
                  },
                  "SyncNodeKeyPair"
               ]
            },
            "Monitoring":true,
            "SecurityGroups":[
               {
                  "Ref":"SyncNodeSecurityGroup"
               },
               "bastion-client"
            ],
            "Tags":[
               {
                  "Key":"App",
                  "Value":{"Fn::FindInMap":[ "VariableMap", "Stack", "App" ]}
               },
               {
                  "Key":"Env",
                  "Value":{
                     "Ref":"Environment"
                  }
               },
               {
                  "Key":"Type",
                  "Value":{"Fn::FindInMap":[ "VariableMap", "Stack", "Type" ]}
               },
               {
                  "Key":"Stack",
                  "Value":{
                     "Ref":"AWS::StackName"
                  }
               },
               {
                  "Key":"Name",
                  "Value":{
                     "Fn::Join":[
                        "-",
                        [
                           {
                              "Ref":"Environment"
                           },
                           "sync-node",
                           {
                              "Ref":"NodeNumber"
                           }
                        ]
                     ]
                  }
               },
               {
                  "Key":"Services",
                  "Value":"sync1.5"
               }
            ],
            "UserData":{
               "Fn::Base64":{
                  "Fn::Join":[
                     "",
                     [
                        "#!/bin/bash\n",
                        "yum update -y aws-cfn-bootstrap\n",
                        "/opt/aws/bin/cfn-init ",
                        "         --stack ",
                        {
                           "Ref":"AWS::StackName"
                        },
                        "         --resource SyncNodeInstance ",
                        "         --region ",
                        {
                           "Ref":"AWS::Region"
                        },
                        "         --verbose\n",
                        "CFNSTATUS=$?\n",
                        "/opt/aws/bin/cfn-signal --exit-code $CFNSTATUS ",
                        "  --data \"$(/opt/ec2/tools/bin/ec2-metadata -p | awk '{ print $2 }')\" ",
                        "'",
                        {
                           "Ref":"SyncNodeWaitConditionHandle"
                        },
                        "'",
                        "\n"
                     ]
                  ]
               }
            }
         }
      },
      "SyncNodeWaitConditionHandle":{
         "Type":"AWS::CloudFormation::WaitConditionHandle"
      },
      "SyncNodeWaitCondition":{
         "Type":"AWS::CloudFormation::WaitCondition",
         "DependsOn":"SyncNodeInstance",
         "Properties":{
            "Handle":{
               "Ref":"SyncNodeWaitConditionHandle"
            },
            "Timeout":"900"
         }
      },
      "SyncNodeDNSRecord":{
         "Type":"AWS::Route53::RecordSet",
         "DependsOn":"SyncNodeInstance",
         "Properties":{
            "HostedZoneName":{
               "Fn::FindInMap":[
                  "EnvironmentMap",
                  {
                     "Ref":"Environment"
                  },
                  "DNSZone"
               ]
            },
            "Name":{
               "Fn::Join":[
                  "",
                  [
                     "sync-",
                     {
                        "Ref":"NodeNumber"
                     },
                     "-",
                     {
                        "Ref":"AWS::Region"
                     },
                     ".",
                     {
                        "Fn::FindInMap":[
                           "EnvironmentMap",
                           {
                              "Ref":"Environment"
                           },
                           "DNSZone"
                        ]
                     }
                  ]
               ]
            },
            "Type":"A",
            "TTL":"30",
            "SetIdentifier":{
               "Ref":"AWS::StackName"
            },
            "Weight":10,
            "ResourceRecords":[
               {
                  "Fn::GetAtt":[
                     "SyncNodeInstance",
                     "PublicIp"
                  ]
               }
            ]
         }
      }
   },
   "Outputs":{
      "SyncNodePublicDNSName":{
         "Description":"DNS Name of the Sync Node",
         "Value":{
            "Fn::GetAtt":[
               "SyncNodeInstance",
               "PublicDnsName"
            ]
         }
      },
      "SyncNodePublicIp":{
          "Description":"Public IP address of the Sync Node",
          "Value":{
              "Fn::GetAtt":[
                 "SyncNodeInstance",
                 "PublicIp"
              ]
           }
      }
   }
}
